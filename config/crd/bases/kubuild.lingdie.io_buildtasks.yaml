---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: buildtasks.kubuild.lingdie.io
spec:
  group: kubuild.lingdie.io
  names:
    kind: BuildTask
    listKind: BuildTaskList
    plural: buildtasks
    singular: buildtask
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.phase
      name: Phase
      type: string
    - jsonPath: .spec.image
      name: Image
      type: string
    - jsonPath: .status.jobName
      name: Job
      type: string
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: BuildTask is the Schema for the buildtasks API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: spec defines the desired state of BuildTask
            properties:
              backoffLimit:
                description: backoffLimit is the Job backoffLimit (retries on failure).
                format: int32
                minimum: 0
                type: integer
              buildArgs:
                additionalProperties:
                  type: string
                description: buildArgs are build-time args.
                type: object
              buildah:
                description: buildah configures rootless buildah options.
                properties:
                  env:
                    description: env optionally sets extra environment variables for
                      buildah container.
                    items:
                      description: EnvVar represents an environment variable present
                        in a Container.
                      properties:
                        name:
                          description: |-
                            Name of the environment variable.
                            May consist of any printable ASCII characters except '='.
                          type: string
                        value:
                          description: |-
                            Variable references $(VAR_NAME) are expanded
                            using the previously defined environment variables in the container and
                            any service environment variables. If a variable cannot be resolved,
                            the reference in the input string will be unchanged. Double $$ are reduced
                            to a single $, which allows for escaping the $(VAR_NAME) syntax: i.e.
                            "$$(VAR_NAME)" will produce the string literal "$(VAR_NAME)".
                            Escaped references will never be expanded, regardless of whether the variable
                            exists or not.
                            Defaults to "".
                          type: string
                        valueFrom:
                          description: Source for the environment variable's value.
                            Cannot be used if value is not empty.
                          properties:
                            configMapKeyRef:
                              description: Selects a key of a ConfigMap.
                              properties:
                                key:
                                  description: The key to select.
                                  type: string
                                name:
                                  default: ""
                                  description: |-
                                    Name of the referent.
                                    This field is effectively required, but due to backwards compatibility is
                                    allowed to be empty. Instances of this type with an empty value here are
                                    almost certainly wrong.
                                    More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names
                                  type: string
                                optional:
                                  description: Specify whether the ConfigMap or its
                                    key must be defined
                                  type: boolean
                              required:
                              - key
                              type: object
                              x-kubernetes-map-type: atomic
                            fieldRef:
                              description: |-
                                Selects a field of the pod: supports metadata.name, metadata.namespace, `metadata.labels['<KEY>']`, `metadata.annotations['<KEY>']`,
                                spec.nodeName, spec.serviceAccountName, status.hostIP, status.podIP, status.podIPs.
                              properties:
                                apiVersion:
                                  description: Version of the schema the FieldPath
                                    is written in terms of, defaults to "v1".
                                  type: string
                                fieldPath:
                                  description: Path of the field to select in the
                                    specified API version.
                                  type: string
                              required:
                              - fieldPath
                              type: object
                              x-kubernetes-map-type: atomic
                            fileKeyRef:
                              description: |-
                                FileKeyRef selects a key of the env file.
                                Requires the EnvFiles feature gate to be enabled.
                              properties:
                                key:
                                  description: |-
                                    The key within the env file. An invalid key will prevent the pod from starting.
                                    The keys defined within a source may consist of any printable ASCII characters except '='.
                                    During Alpha stage of the EnvFiles feature gate, the key size is limited to 128 characters.
                                  type: string
                                optional:
                                  default: false
                                  description: |-
                                    Specify whether the file or its key must be defined. If the file or key
                                    does not exist, then the env var is not published.
                                    If optional is set to true and the specified key does not exist,
                                    the environment variable will not be set in the Pod's containers.

                                    If optional is set to false and the specified key does not exist,
                                    an error will be returned during Pod creation.
                                  type: boolean
                                path:
                                  description: |-
                                    The path within the volume from which to select the file.
                                    Must be relative and may not contain the '..' path or start with '..'.
                                  type: string
                                volumeName:
                                  description: The name of the volume mount containing
                                    the env file.
                                  type: string
                              required:
                              - key
                              - path
                              - volumeName
                              type: object
                              x-kubernetes-map-type: atomic
                            resourceFieldRef:
                              description: |-
                                Selects a resource of the container: only resources limits and requests
                                (limits.cpu, limits.memory, limits.ephemeral-storage, requests.cpu, requests.memory and requests.ephemeral-storage) are currently supported.
                              properties:
                                containerName:
                                  description: 'Container name: required for volumes,
                                    optional for env vars'
                                  type: string
                                divisor:
                                  anyOf:
                                  - type: integer
                                  - type: string
                                  description: Specifies the output format of the
                                    exposed resources, defaults to "1"
                                  pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                                  x-kubernetes-int-or-string: true
                                resource:
                                  description: 'Required: resource to select'
                                  type: string
                              required:
                              - resource
                              type: object
                              x-kubernetes-map-type: atomic
                            secretKeyRef:
                              description: Selects a key of a secret in the pod's
                                namespace
                              properties:
                                key:
                                  description: The key of the secret to select from.  Must
                                    be a valid secret key.
                                  type: string
                                name:
                                  default: ""
                                  description: |-
                                    Name of the referent.
                                    This field is effectively required, but due to backwards compatibility is
                                    allowed to be empty. Instances of this type with an empty value here are
                                    almost certainly wrong.
                                    More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names
                                  type: string
                                optional:
                                  description: Specify whether the Secret or its key
                                    must be defined
                                  type: boolean
                              required:
                              - key
                              type: object
                              x-kubernetes-map-type: atomic
                          type: object
                      required:
                      - name
                      type: object
                    type: array
                  rootless:
                    default: true
                    description: |-
                      rootless indicates the job should run rootless.
                      Must be true for this controller.
                    type: boolean
                  storageDriver:
                    description: 'storageDriver configures containers/storage driver
                      (common values: overlay, vfs).'
                    type: string
                type: object
                x-kubernetes-validations:
                - message: buildah.rootless must be true; privileged mode is not supported
                  rule: '!has(self.rootless) || self.rootless == true'
              cache:
                description: cache configures optional cache storage.
                properties:
                  enabled:
                    description: enabled enables build cache.
                    type: boolean
                  pvcName:
                    description: pvcName references an existing PVC for cache storage
                      (same namespace).
                    type: string
                  subPath:
                    description: subPath is an optional path within the PVC.
                    type: string
                type: object
              context:
                description: context defines where the build context comes from.
                properties:
                  git:
                    description: git defines the git repository context.
                    properties:
                      depth:
                        description: depth optionally performs a shallow clone.
                        format: int32
                        minimum: 1
                        type: integer
                      revision:
                        description: revision is a branch, tag, or commit sha.
                        type: string
                      secretRef:
                        description: |-
                          secretRef optionally references credentials (e.g. SSH key, token) for private repos.
                          The Secret must be in the same namespace as the BuildTask.
                        properties:
                          name:
                            description: name is the name of the Secret.
                            minLength: 1
                            type: string
                        required:
                        - name
                        type: object
                      subPath:
                        description: subPath is a path inside the repo to use as build
                          context.
                        type: string
                      url:
                        description: url is the git repo URL.
                        minLength: 1
                        type: string
                    required:
                    - url
                    type: object
                  pvc:
                    description: pvc defines the PVC-based context.
                    properties:
                      claimName:
                        description: claimName is the PVC name.
                        minLength: 1
                        type: string
                      path:
                        default: /
                        description: path is a path inside the mounted PVC to use
                          as build context.
                        type: string
                    required:
                    - claimName
                    type: object
                  s3:
                    description: s3 defines an S3/OSS object-based context (e.g. tarball).
                    properties:
                      bucket:
                        description: bucket is the bucket name.
                        minLength: 1
                        type: string
                      endpoint:
                        description: endpoint is the S3-compatible endpoint (optional).
                        type: string
                      key:
                        description: key is the object key (e.g. a tarball containing
                          build context).
                        minLength: 1
                        type: string
                      region:
                        description: region is the region (optional).
                        type: string
                      secretRef:
                        description: |-
                          secretRef references credentials for S3/OSS access (required for private buckets).
                          The Secret must be in the same namespace as the BuildTask.
                        properties:
                          name:
                            description: name is the name of the Secret.
                            minLength: 1
                            type: string
                        required:
                        - name
                        type: object
                    required:
                    - bucket
                    - key
                    type: object
                  type:
                    description: type selects which context source to use.
                    enum:
                    - Git
                    - PVC
                    - S3
                    type: string
                required:
                - type
                type: object
                x-kubernetes-validations:
                - message: when context.type=Git, context.git must be set and pvc/s3
                    must be empty
                  rule: 'self.type == ''Git'' ? has(self.git) && !has(self.pvc) &&
                    !has(self.s3) : true'
                - message: when context.type=PVC, context.pvc must be set and git/s3
                    must be empty
                  rule: 'self.type == ''PVC'' ? has(self.pvc) && !has(self.git) &&
                    !has(self.s3) : true'
                - message: when context.type=S3, context.s3 must be set and git/pvc
                    must be empty
                  rule: 'self.type == ''S3'' ? has(self.s3) && !has(self.git) && !has(self.pvc)
                    : true'
              dockerfile:
                description: dockerfile defines where Dockerfile is loaded from.
                properties:
                  inline:
                    description: inline is the inline Dockerfile content (used when
                      type=Inline).
                    type: string
                  path:
                    default: Dockerfile
                    description: path is a path within the build context (used when
                      type=Path).
                    type: string
                  type:
                    description: type selects path or inline Dockerfile.
                    enum:
                    - Path
                    - Inline
                    type: string
                required:
                - type
                type: object
                x-kubernetes-validations:
                - message: when dockerfile.type=Path, dockerfile.path must be non-empty
                    and dockerfile.inline must be empty
                  rule: 'self.type == ''Path'' ? (self.path != '''' && self.inline
                    == '''') : true'
                - message: when dockerfile.type=Inline, dockerfile.inline must be
                    non-empty
                  rule: 'self.type == ''Inline'' ? (self.inline != '''') : true'
              image:
                description: image is the primary target image reference (e.g. registry/repo:tag).
                minLength: 1
                type: string
              output:
                description: output controls push behavior and extra tags.
                properties:
                  images:
                    description: images are additional image references (tags) to
                      push, besides spec.image.
                    items:
                      type: string
                    type: array
                  insecure:
                    description: insecure allows plain HTTP registry (not recommended).
                    type: boolean
                  push:
                    default: true
                    description: push controls whether to push built image(s) to the
                      registry.
                    type: boolean
                  skipTLSVerify:
                    description: skipTLSVerify skips TLS verification when talking
                      to registries.
                    type: boolean
                type: object
              pushSecretRef:
                description: |-
                  pushSecretRef references docker registry credentials (kubernetes.io/dockerconfigjson).
                  The Secret must be in the same namespace as the BuildTask.
                properties:
                  name:
                    description: name is the name of the Secret.
                    minLength: 1
                    type: string
                required:
                - name
                type: object
              resources:
                description: resources defines compute resource requests/limits for
                  the build container.
                properties:
                  claims:
                    description: |-
                      Claims lists the names of resources, defined in spec.resourceClaims,
                      that are used by this container.

                      This field depends on the
                      DynamicResourceAllocation feature gate.

                      This field is immutable. It can only be set for containers.
                    items:
                      description: ResourceClaim references one entry in PodSpec.ResourceClaims.
                      properties:
                        name:
                          description: |-
                            Name must match the name of one entry in pod.spec.resourceClaims of
                            the Pod where this field is used. It makes that resource available
                            inside a container.
                          type: string
                        request:
                          description: |-
                            Request is the name chosen for a request in the referenced claim.
                            If empty, everything from the claim is made available, otherwise
                            only the result of this request.
                          type: string
                      required:
                      - name
                      type: object
                    type: array
                    x-kubernetes-list-map-keys:
                    - name
                    x-kubernetes-list-type: map
                  limits:
                    additionalProperties:
                      anyOf:
                      - type: integer
                      - type: string
                      pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                      x-kubernetes-int-or-string: true
                    description: |-
                      Limits describes the maximum amount of compute resources allowed.
                      More info: https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/
                    type: object
                  requests:
                    additionalProperties:
                      anyOf:
                      - type: integer
                      - type: string
                      pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                      x-kubernetes-int-or-string: true
                    description: |-
                      Requests describes the minimum amount of compute resources required.
                      If Requests is omitted for a container, it defaults to Limits if that is explicitly specified,
                      otherwise to an implementation-defined value. Requests cannot exceed Limits.
                      More info: https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/
                    type: object
                type: object
              retention:
                description: retention defines TTL policy for successful/failed Jobs
                  created by this BuildTask.
                properties:
                  failedJobsTTLSecondsAfterFinished:
                    description: failedJobsTTLSecondsAfterFinished sets TTL for failed
                      jobs.
                    format: int32
                    minimum: 0
                    type: integer
                  successfulJobsTTLSecondsAfterFinished:
                    description: successfulJobsTTLSecondsAfterFinished sets TTL for
                      successful jobs.
                    format: int32
                    minimum: 0
                    type: integer
                type: object
              serviceAccountName:
                description: serviceAccountName is the ServiceAccount used by the
                  Job.
                type: string
              timeoutSeconds:
                description: timeoutSeconds limits the max duration of a build (mapped
                  to Job activeDeadlineSeconds).
                format: int64
                minimum: 1
                type: integer
              trigger:
                description: trigger controls manual trigger behavior.
                properties:
                  manual:
                    description: manual trigger; changing nonce requests a new build.
                    properties:
                      nonce:
                        description: |-
                          nonce is an arbitrary string. Changing it triggers a new build.
                          Common patterns: unix timestamp, git sha, or a UUID.
                        type: string
                    type: object
                type: object
            required:
            - context
            - image
            type: object
          status:
            description: status defines the observed state of BuildTask
            properties:
              conditions:
                description: |-
                  conditions represent the current state of the BuildTask resource.
                  Each condition has a unique type and reflects the status of a specific aspect of the resource.

                  Standard condition types include:
                  - "Available": the resource is fully functional
                  - "Progressing": the resource is being created or updated
                  - "Degraded": the resource failed to reach or maintain its desired state

                  The status of each condition is one of True, False, or Unknown.
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              endTime:
                description: endTime is when the build completed.
                format: date-time
                type: string
              imageDigest:
                description: imageDigest is the resulting image digest (e.g. sha256:...).
                type: string
              jobName:
                description: jobName is the name of the Job created for this build.
                type: string
              lastTriggerNonce:
                description: lastTriggerNonce is the last observed trigger nonce.
                type: string
              logURL:
                description: logURL is an optional URL pointing to build logs.
                type: string
              observedGeneration:
                description: observedGeneration is the most recent generation observed
                  by the controller.
                format: int64
                type: integer
              phase:
                description: phase is a coarse-grained state machine for the build.
                enum:
                - Pending
                - Running
                - Succeeded
                - Failed
                type: string
              podName:
                description: podName is the latest Pod name of the Job (best-effort,
                  may change across retries).
                type: string
              startTime:
                description: startTime is when the build started.
                format: date-time
                type: string
            type: object
        required:
        - spec
        type: object
    served: true
    storage: true
    subresources:
      status: {}
