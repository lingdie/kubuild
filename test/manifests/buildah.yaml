apiVersion: v1
kind: Pod
metadata:
  name: buildah-rootless
spec:
  restartPolicy: Never
  containers:
  - name: build
    image: quay.io/buildah/stable:latest
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
    command: ["/bin/sh","-lc"]
    args:
      - |
        set -eux
        cd /tmp
        cat > Dockerfile <<'EOF'
        FROM alpine:3.20
        RUN echo "hello from rootless buildah" > /hello.txt
        CMD ["cat","/hello.txt"]
        EOF

        export XDG_RUNTIME_DIR=/tmp/run
        mkdir -p /tmp/run

        buildah --storage-driver=vfs bud -t demo:latest .
        buildah images
