apiVersion: v1
kind: Pod
metadata:
  name: buildkit-rootless
spec:
  restartPolicy: Never
  containers:
  - name: build
    image: moby/buildkit:rootless
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
    command: ["/bin/sh","-lc"]
    args:
      - |
        set -eux

        cd /tmp

        cat > Dockerfile <<'EOF'
        FROM alpine:3.20
        RUN echo "hello from rootless buildkit" > /hello.txt
        CMD ["cat","/hello.txt"]
        EOF

        buildctl-daemonless.sh build \
          --frontend dockerfile.v0 \
          --local context=. \
          --local dockerfile=. \
          --output type=oci,dest=/workspace/image.oci.tar

        ls -lh /workspace/image.oci.tar
